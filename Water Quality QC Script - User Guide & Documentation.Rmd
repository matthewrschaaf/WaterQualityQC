---
title: 'Water Quality QC Script: User Guide & Documentation'
author: "Matthew Schaaf"
date: "2025-08-18"
output: 
  html_document:
    toc: true
    toc_float: true
    theme: united
---

```{r setup, include=FALSE}
# This chunk sets up the report but won't be visible in the output.
knitr::opts_chunk$set(echo = TRUE, message = TRUE, warning = TRUE)
library(dplyr)
```

# Introduction

This document provides a comprehensive overview of the Water Quality QC Analysis project. Its purpose is to guide the user through the script's functionality, explain its outputs, and outline considerations for future use and maintenance.

# Instructions for Use

## 1. Project Setup

The entire project is contained within an RStudio Project (`.Rproj` file). All scripts (`main_qc_analysis.R`, `01_...`, etc.) should be in the same folder located here: `"O:\ED\Private\Water Quality\Co-op & Others Oversight\Matthew Schaaf\QualityControl\_and_ProgramActivityCloseoutReport\WaterQualityQC".`

## 2. Running the Analysis

The entire analysis is run from a single master script. Sourcing this file will initiate the user interface and run the complete workflow.

```{r, eval=FALSE}
# To run the entire analysis:
source("main_qc_analysis.R")
```

# How the Script Works

The project is divided into several modular scripts, each with a specific purpose. The `main_qc_analysis.R` script controls the overall workflow.

## Data Preparation (`01_data_preparation_functions.R`)

This script is responsible for connecting to the Access database, fetching the required raw data tables, performing necessary joins, and cleaning the data into an analysis-ready format.

Cleaning consists of renaming and reordering of columns as well as deduplication of tables if multiple identical entries are found within the access database. The deduplication logic is seen below:

```{r, eval=FALSE}
# Deduplication code
    message("\nDeduplicating the Final_Merged_Data dataframe...")
    
    # --- Step 1: Isolate rows that are NOT true duplicates ---
    discrepancies_and_uniques_chem <- final_merged_df %>%
      group_by(Loc_ID, Assoc_Samp, Storet_Num, QC_Type) %>%
      filter(n_distinct(Text_QC_Value) > 1 | n_distinct(Text_Field_Value) > 1 | n() == 1) %>%
      ungroup()
    
    # --- Step 2: Isolate and deduplicate the TRUE duplicates ---
    true_duplicates_chem <- final_merged_df %>%
      group_by(Loc_ID, Assoc_Samp, Storet_Num, QC_Type) %>%
      filter(n_distinct(Text_QC_Value) == 1 & n_distinct(Text_Field_Value) == 1 & n() > 1) %>%
      slice(1) %>%
      ungroup()
    
    # --- Step 3: Combine the two sets back into the final dataframe ---
    final_merged_df <- bind_rows(
      discrepancies_and_uniques_chem, 
      true_duplicates_chem
    )
    
    message("-> Deduplication of Final_Merged_Data complete.")
```

## Data Screening (`02_data_screening_functions.R`)

This script takes the prepared data and applies the quality control criteria. For chemical data, it calculates the Relative Percent Difference (RPD) and applies a two-tiered pass/fail system. For biological data, it calculates the Bray-Curtis Dissimilarity Index.

### Chemical Data Screening

**RPD Calculation** The Relative Percent Difference (RPD) is the primary metric for comparing duplicate and split samples. It is calculated with the following formula, which uses absolute values to ensure the result is always positive:

```{r, eval=FALSE}
# RPD calculation (independent of LOQ)
RPD <- if_else(
  (abs(QC_Value) + abs(Field_Value)) == 0, 
  0, 
  abs(abs(QC_Value) - abs(Field_Value)) / ((abs(QC_Value) + abs(Field_Value)) / 2) * 100
)
```

### Pass/Fail Logic

The script then uses the calculated RPD or the Limit of Quantitation (LOQ) to apply pass/fail criteria in a sequential, two-step process.

Criteria 1 serves as an initial, broad check for all applicable samples.

```{r, eval=FALSE}
# --- Step 1: Calculate Criteria 1 for all samples ---
QC_Failed_Criteria1 <- case_when(
  QC_Type %in% c("FBLK", "RNS") & is.na(QC_LOQ) ~ NA_character_,
  QC_Type %in% c("FBLK", "RNS") & QC_Value >= QC_LOQ ~ "Fail",
  QC_Type %in% c("DDL", "DUP", "SPL") & RPD > 20 ~ "Fail",
  Parameter == "ORP" & RPD > 20 ~ "Fail",
  TRUE ~ "Pass"
)
```

If a duplicate or split sample fails Criteria 1 and has a valid LOQ, it proceeds to the more nuanced Criteria 2. If a sample passes Criteria 1, its overall result is "Pass" and it is not evaluated against Criteria 2.

```{r, eval=FALSE}
# --- Step 2: Calculate Criteria 2 ONLY if necessary ---
QC_Failed_Criteria2 <- case_when(
  QC_Failed_Criteria1 == "Pass" ~ NA_character_,
  is.na(QC_LOQ) ~ "Can Not Be Calculated due to NA LOQ",
  !QC_Type %in% c("DDL", "DUP", "SPL") ~ QC_Failed_Criteria1,
  
  # For duplicates that failed C1 and have a valid LOQ:
  QC_Value == 0 & Field_Value == 0 ~ "Pass",
  abs(QC_Value) >= 5 * QC_LOQ & abs(Field_Value) >= 5 * QC_LOQ & RPD > 20 ~ "Fail",
  abs(QC_Value) < 5 * QC_LOQ | abs(Field_Value) < 5 * QC_LOQ & abs(abs(QC_Value) - abs(Field_Value)) > 2 * QC_LOQ ~ "Fail",
  TRUE ~ "Pass"
)
```

The Final Overall Status is then determined based on the results of this sequential check.

```{r, eval=FALSE}
# --- Step 3: Determine Final Overall Status ---
QC_Failed_Overall <- case_when(
  QC_Failed_Criteria1 == "Pass" ~ "Pass",
  QC_Failed_Criteria2 == "Can Not Be Calculated due to NA LOQ" ~ QC_Failed_Criteria1,
  TRUE ~ QC_Failed_Criteria2
)
```

### Special Cases

**Total Nitrogen:** This parameter has a special rule. It does not go through the standard criteria checks. Instead, its QC_Failed_Overall status is marked as "Fail" if either of its components (Kjeldahl, Tot or NO2+NO3, Tot) fail within the same sample group. Otherwise, it is marked as "Pass".

### Biological Data Screening

For phytoplankton and zooplankton samples, precision is assessed using the Bray-Curtis Dissimilarity Index, with a value of â‰¤ 0.25 considered a pass. The calculation is performed for each unique sample pair.

```{r, eval=FALSE}
bray_curtis_results <- final_bio_df %>%
  # Step 1: Filter out any rows where the key identifiers are missing
  filter(!is.na(Loc_ID) & !is.na(OG_Sample)) %>%
  
  # Step 2: Group the data by each unique sample pair
  group_by(Loc_ID, OG_Sample, QC_Type, Sample_Type) %>%
  
  # Step 3: Summarise the data for each group
  summarise(
    Sum_A = sum(Density_OG, na.rm = TRUE),
    Sum_B = sum(Density_QC, na.rm = TRUE),
    Sum_C = sum(pmin(Density_OG, Density_QC), na.rm = TRUE),
    .groups = 'drop'
  ) %>%
  
  mutate(
    Bray_Curtis_Index = if_else(
      (Sum_A + Sum_B) == 0,
      0,
      1 - (2 * Sum_C) / (Sum_A + Sum_B)
    ),
    BC_Result = if_else(Bray_Curtis_Index <= 0.25, "Pass", "Fail")
  )
```

## Calibration Tracking (`05_calibration_sheet.R`)

This script brings in the calibration tracking sheet, as well as the Results table. It then cross-references to provide the latest relative calibration date. This is then used to see if calibration frequencies are being upheld to assure measurement accuracy.

## Final Report (`04_generate_report.R`)

This script takes all the processed data and summary statistics and writes them to a multi-sheet Excel file.

# Inputs

This section details all the external data sources required for the script to run.

## Access Database

The primary data source is a Microsoft Access database.

**Connection Path:** `Driver={Microsoft Access Driver (*.mdb, *.accdb)};DBQ=O:/ED/Private/Water Quality/DASLER/Louisville_DASLER 81.mdb`

### Tables Fetched in `01_data_preparation_functions.R`

-   **[QC Results]:** `LOC_ID`, `QC_SAMPLE`, `LAB_ID`, `STORET_NUM`, `UNITS`, `VALUE`, `TEXT_VALUE`, `PQUANT`, `QC_TYPE`, `LAB_SNUM`
-   **[QC Samples]:** `LOC_ID`, `QC_SAMPLE`, `QC_TYPE`, `ASSOC_SAMP`, `SAMPLE_TYPE`
-   **[Results]:** `LOC_ID`, `SAMPLE_NUM`, `VALUE`, `TEXT_VALUE`, `STORET_NUM`, `UNITS`, `LAB_SNUM`, `LAB_ID`, `PQUANT`
-   **[Analytes]:** `STORET_NUM`, `ANL_SHORT`
-   **[QC Biosamples]:** `Loc_ID`, `QC_Sample`, `Sample_Type`, `QC_Type`, `Assoc_Samp`
-   **[QC Bioresults]:** `LOC_ID`, `QC_SAMPLE`, `LAB_ID`, `SAMPLE_TYPE`, `TAXACODE`, `COUNT`, `BIOVOLUME`, `DENSITY`, `QC_TYPE`, `DENSITY_UNITS`, `BV_UNITS`, `ANAL_METHOD`
-   **[BioResults]:** `sample_num`, `loc_id`, `taxacode`, `lab_id`, `sample_type`, `count`, `biovolume`, `density`, `anal_method`, `count_units`, `density_units`, `bv_units`
-   **[Sample Type Codes]:** `SAMPLE_TYPE`, `TYPE_NAME`
-   **[Taxa]:** `taxacode`, `sci_name`, `com_name`, `itis_tsn`
-   **[Locations]:** `LOC_ID`, `LAT_DEG`, `LAT_MIN`, `LAT_SEC`, `LONG_DEG`, `LONG_MIN`, `LONG_SEC`, `LOC_DESC`

## Calibration Log

Instrument calibration data is read from a shared Excel file.

**File Path:** `O:\ED\Private\Water Quality\Data\FY2025\2025 Field\Calibration Log\Calibration Logs.xlsx`

### Sheets Imported in `05_calibration_sheet.R`

-   **DO:** `Analyst`, `Date`, `Time`, `Barom_Pressure_mmHg`, `Temp`, `Initial_DO_mgL`, `Initial_DO_pct`, `Calibrated_DO_mgL`, `Calibrated_DO_pct`
-   **Specific Conductance:** `Analyst`, `Date`, `Time`, `SC_Temp`, `Initial_SC`, `Standard_SC`, `Calibrated_SC`
-   **pH:** `Analyst`, `Date`, `Time`, `pH_Temp`, `pH7_Initial`, `pH7_Standard`, `pH7_Calibrated`, `pH4_Initial`, `pH4_Standard`, `pH4_Calibrated`, `pH10_Initial`, `pH10_Standard`, `pH10_Calibrated`
-   **ORP:** `Analyst`, `Cal_Date`, `Time`, `Next_Cal_Date`, `ORP_Temp`, `ORP_Initial`, `ORP_Standard`, `ORP_Calibrated`
-   **Turbidity:** `Analyst`, `Cal_Date`, `Time`, `Next_Cal_Date`, `Turb_Temp`, `Turb_0_Initial`, `Turb_0_Calibrated`, `Turb_124_Initial`, `Turb_124_Calibrated`
-   **Phycocyanin:** `Analyst`, `Cal_Date`, `Time`, `Next_Cal_Date`, `PC_RFU_Temp`, `PC_RFU_0_Init`, `PC_RFU_0_Post`, `PC_RFU_Initial`, `PC_RFU_Standard`, `PC_RFU_Calibrated`
-   **Chlorophyll:** `Analyst`, `Cal_Date`, `Time`, `Next_Cal_Date`, `Chl_Temp`, `Chl_RFU_0_Init`, `Chl_RFU_0_Post`, `Chl_RFU_Initial`, `Chl_RFU_Standard`, `Chl_RFU_Calibrated`, `Chl_ugL_0_Init`, `Chl_ugL_0_Post`, `Chl_ugL_Initial`, `Chl_ugL_Standard`, `Chl_ugL_Calibrated`
-   **Chlorophyll Standards Table**
-   **Standards**

------------------------------------------------------------------------

# R Environment Outputs

After running the `main_qc_analysis.R` script, a single, organized list object named `analysis_results` is created in the R environment. It has the following nested structure:

-   **`analysis_results$Chem`**

    -   **`QC_Results_Filtered`:** Processed QC Results with an additional `QC_Sample_Date` column.
    -   **`QC_Samples_Raw`:** Raw data from the `[QC Samples]` table.
    -   **`Results_Raw`:** Raw, deduplicated data from the `[Results]` table.
    -   **`Analytes_Raw`:** Raw data from the `[Analytes]` table.
    -   **`Final_Merged_Data`:** A fully merged dataframe of all chemical data with `NA` values handled and units converted.

-   **`analysis_results$Bio`**

    -   **`QC_Bioresults_Filtered`:** Filtered data from `[QC Bioresults]` for relevant sample types (PQN, PQL, ZQL, ZQN).
    -   **`QC_Biosamples_Raw`:** Filtered data from `[QC Biosamples]` for relevant sample types.
    -   **`Bioresults_Raw`:** Raw data from the `[BioResults]` table.
    -   **`Sample_Type_Codes`:** Raw data from the `[Sample Type Codes]` table.
    -   **`Taxa_Raw`:** Raw data from the `[Taxa]` table.
    -   **`Final_Merged_BioData`:** A fully merged dataframe of all biological data, used for community analysis.

-   **`analysis_results$Screened`**

    -   **`Screened_Chem_Data`:** The `Final_Merged_Data` after applying RPD calculations and the two-tiered pass/fail criteria.
    -   **`Split_Screened_Chem_Data`:** A list of dataframes, where `Screened_Chem_Data` is split by each unique `QC_Type`.
    -   **`Screened_Sediment_Data`:** A subset of `Screened_Chem_Data` containing only sediment samples (`Sample_Type == 'S'`).

-   **`analysis_results$Bray_Curtis_Results`:** A dataframe showing the calculated Bray-Curtis Index for each biological sample pair.

-   **`analysis_results$Locations_Data`:** A dataframe containing location information (including degree coordinates) for only the locations present in the Results table.

-   **`analysis_results$Calibration_Data`:**

    -   **`Raw_Calibration_Logs`:** A list of dataframes, one for each imported sheet from the calibration log.
    -   **`Cleaned_Calibration_Logs`:** A list of dataframes containing only the cleaned date columns from the logs.
    -   **`Identified_Sampling_Days`:** A summary table of unique sampling days taken from the Results table.
    -   **`Final_Calibration_Sheet`:** The final calibration tracking sheet that is written to the Excel report.
    -   **`Lake_Profiles_Sheet`:** A subset of the calibration data for days where only DO or DO Saturation were measured.
    -   **`Chlorophyll_Standards`:** Temperature-adjusted standards for chlorophyll and phycocyanin.
    -   **`Standards`:** Standards currently being used for calibration.

# Excel Sheet Outputs

The primary output is an Excel file named `QC_Report_[StartDate]_to_[EndDate].xlsx`. This file contains multiple sheets, including:

-   **Locations Sampled:** A table showing all locations sampled across the user given time period.
-   **Samples Collected vs Projected:** A placeholder sheet that works to track whether all expected samples (both normal and QC) were collected.
-   **Sediment QC Results:** A table with all QC samples that have a Sample_Type of "S" (for sediment), with pass/fail results highlighted.
-   **DUP Phys QC Results:** A table for all QC samples that have a QC_Lab_ID of "FIELD", with pass/fail results highlighted.
-   **DUP Chem QC Results:** A detailed table of all duplicate samples, with pass/fail results highlighted.
-   **SPL Chem QC Results:** A detailed table of all split samples, with pass/fail results highlighted.
-   **RNS Chem QC Results:** A detailed table of all rinse samples, with pass/fail results highlighted.
-   **Various Chem QC Results:** These can include FBLK, TBLK, or DDL (if necessary), with pass/fail results highlighted.
-   **All Bio QC Results:** A table of all biological QC samples taken.
-   **Bio Summary Statistics:** A table detailing results of QC done for biological samples.
-   **Calibration Tracking:** A sheet that matches sampling dates to the most recent valid instrument calibration.
-   **SOP Deviations:** A placeholder sheet for documenting any deviations from SOPs during the given project.

# Future Considerations & Maintenance

## Annual Updates

Certain parts of the script may require updates from year to year.

### Calibration Log File Path

The path to the calibration log is hardcoded in `05_calibration_sheet.R`. If this file is moved or a new annual file is created, this path must be updated.

```{r, eval=FALSE}
# Path to update in 05_calibration_sheet.R:
calibration_log_path <- "O:/ED/Private/Water Quality/Data/FY2025/2025 Field/Calibration Log/Calibration Logs.xlsx"
```

## Script Enhancements

-   **Dynamic GUI Choices:** The ability to select lakes and QC types within the GUI were removed. A future improvement could be to populate these lists dynamically from the database.
-   **Error Handling:** More robust error handling could be added to provide more specific feedback to the user if a database connection or file read fails.
